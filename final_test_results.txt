============================= test session starts ==============================
platform linux -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
hypothesis profile 'caracal'
rootdir: /home/raw/Documents/workspace/caracalEcosystem/Caracal
configfile: pyproject.toml
plugins: hypothesis-6.151.4, cov-7.0.0, anyio-4.12.1
collecting ... collected 8 items

tests/unit/test_cli_policy.py::TestPolicyCLI::test_policy_list_json_format PASSED [ 12%]
tests/unit/test_cli_policy.py::TestPolicyCLI::test_policy_get_json_format PASSED [ 25%]
tests/unit/test_persistence_retry.py::TestAgentRegistryRetry::test_agent_registry_persist_with_transient_failure PASSED [ 37%]
tests/unit/test_persistence_retry.py::TestAgentRegistryRetry::test_agent_registry_persist_permanent_failure FAILED [ 50%]
tests/unit/test_persistence_retry.py::TestPolicyStoreRetry::test_policy_store_persist_with_transient_failure PASSED [ 62%]
tests/unit/test_persistence_retry.py::TestLedgerWriterRetry::test_ledger_writer_append_with_transient_failure FAILED [ 75%]
tests/unit/test_persistence_retry.py::TestPricebookRetry::test_pricebook_persist_with_transient_failure FAILED [ 87%]
tests/unit/test_sdk_client.py::TestCaracalClient::test_get_remaining_budget_no_policy FAILED [100%]

=================================== FAILURES ===================================
E   AttributeError: 'PosixPath' object has no attribute 'endswith'
------------------------------ Captured log call -------------------------------
INFO     caracal.caracal.core.identity:identity.py:86 Initialized new agent registry at /tmp/tmpt5sfecrd/agents.json
/home/raw/Documents/workspace/caracalEcosystem/Caracal/tests/unit/test_persistence_retry.py:56: AttributeError: 'PosixPath' object has no attribute 'endswith'
E   OSError: Simulated transient failure

The above exception was the direct cause of the following exception:
E   caracal.exceptions.LedgerWriteError: Failed to perform atomic append to /tmp/tmpq0ylfg_v/ledger.jsonl: Simulated transient failure

The above exception was the direct cause of the following exception:
E   caracal.exceptions.LedgerWriteError: Failed to append event to ledger /tmp/tmpq0ylfg_v/ledger.jsonl: Failed to perform atomic append to /tmp/tmpq0ylfg_v/ledger.jsonl: Simulated transient failure
------------------------------ Captured log call -------------------------------
INFO     caracal.caracal.core.ledger:ledger.py:108 Created new ledger file at /tmp/tmpq0ylfg_v/ledger.jsonl
ERROR    caracal.caracal.core.ledger:ledger.py:190 Failed to append event to ledger /tmp/tmpq0ylfg_v/ledger.jsonl: Failed to perform atomic append to /tmp/tmpq0ylfg_v/ledger.jsonl: Simulated transient failure
Traceback (most recent call last):
  File "/home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/ledger.py", line 223, in _atomic_append
    with open(self.ledger_path, 'a') as f:
         ~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.14/unittest/mock.py", line 1175, in __call__
    return self._mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.14/unittest/mock.py", line 1179, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.14/unittest/mock.py", line 1240, in _execute_mock_call
    result = effect(*args, **kwargs)
  File "/home/raw/Documents/workspace/caracalEcosystem/Caracal/tests/unit/test_persistence_retry.py", line 127, in mock_open
    raise OSError("Simulated transient failure")
OSError: Simulated transient failure

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/ledger.py", line 183, in append_event
    self._atomic_append(event)
    ~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/retry.py", line 50, in wrapper
    return func(*args, **kwargs)
  File "/home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/ledger.py", line 243, in _atomic_append
    raise LedgerWriteError(
        f"Failed to perform atomic append to {self.ledger_path}: {e}"
    ) from e
caracal.exceptions.LedgerWriteError: Failed to perform atomic append to /tmp/tmpq0ylfg_v/ledger.jsonl: Simulated transient failure
/home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/ledger.py:194: caracal.exceptions.LedgerWriteError: Failed to append event to ledger /tmp/tmpq0ylfg_v/ledger.jsonl: Failed to perform atomic append to /tmp/tmpq0ylfg_v/ledger.jsonl: Simulated transient failure
E   OSError: Simulated transient failure

The above exception was the direct cause of the following exception:
E   caracal.exceptions.FileWriteError: Failed to persist pricebook to /tmp/tmp6xrykoad/pricebook.csv: Simulated transient failure
------------------------------ Captured log call -------------------------------
INFO     caracal.caracal.core.pricebook:pricebook.py:328 Loaded 1 prices from /tmp/tmp6xrykoad/pricebook.csv
/home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/pricebook.py:404: caracal.exceptions.FileWriteError: Failed to persist pricebook to /tmp/tmp6xrykoad/pricebook.csv: Simulated transient failure
E   AssertionError: assert Decimal('0') is None
------------------------------ Captured log call -------------------------------
INFO     caracal.caracal.sdk.client:client.py:67 Initializing Caracal SDK client
INFO     caracal.caracal.config.settings:settings.py:172 Successfully loaded and validated configuration from /tmp/tmp42kextvs/config.yaml
INFO     caracal.caracal.core.identity:identity.py:86 Initialized new agent registry at /tmp/tmp42kextvs/agents.json
INFO     caracal.caracal.core.policy:policy.py:104 Initialized new policy store at /tmp/tmp42kextvs/policies.json
INFO     caracal.caracal.core.pricebook:pricebook.py:328 Loaded 4 prices from /tmp/tmp42kextvs/pricebook.csv
INFO     caracal.caracal.core.ledger:ledger.py:108 Created new ledger file at /tmp/tmp42kextvs/ledger.jsonl
INFO     caracal.caracal.core.policy:policy.py:372 PolicyEvaluator initialized
INFO     caracal.caracal.core.metering:metering.py:73 MeteringCollector initialized
INFO     caracal.caracal.sdk.client:client.py:74 Caracal SDK client initialized successfully
INFO     caracal.caracal.core.identity:identity.py:140 Registered agent: id=ab0ef41d-1e33-48aa-835c-31bb814c74e6, name=test-agent, owner=test@example.com
INFO     caracal.caracal.core.policy:policy.py:401 Budget check denied for agent ab0ef41d-1e33-48aa-835c-31bb814c74e6: No active policy found
/home/raw/Documents/workspace/caracalEcosystem/Caracal/tests/unit/test_sdk_client.py:308: AssertionError: assert Decimal('0') is None
=============================== warnings summary ===============================
tests/unit/test_cli_policy.py::TestPolicyCLI::test_policy_list_json_format
tests/unit/test_cli_policy.py::TestPolicyCLI::test_policy_get_json_format
tests/unit/test_persistence_retry.py::TestAgentRegistryRetry::test_agent_registry_persist_with_transient_failure
tests/unit/test_persistence_retry.py::TestAgentRegistryRetry::test_agent_registry_persist_permanent_failure
tests/unit/test_persistence_retry.py::TestPolicyStoreRetry::test_policy_store_persist_with_transient_failure
tests/unit/test_sdk_client.py::TestCaracalClient::test_get_remaining_budget_no_policy
  /home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/identity.py:123: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    created_at=datetime.utcnow().isoformat() + "Z",

tests/unit/test_cli_policy.py::TestPolicyCLI::test_policy_list_json_format
tests/unit/test_cli_policy.py::TestPolicyCLI::test_policy_get_json_format
tests/unit/test_persistence_retry.py::TestPolicyStoreRetry::test_policy_store_persist_with_transient_failure
  /home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/policy.py:161: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    created_at=datetime.utcnow().isoformat() + "Z",

tests/unit/test_persistence_retry.py::TestLedgerWriterRetry::test_ledger_writer_append_with_transient_failure
  /home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/ledger.py:167: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    timestamp = datetime.utcnow()

tests/unit/test_persistence_retry.py::TestPricebookRetry::test_pricebook_persist_with_transient_failure
  /home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/pricebook.py:159: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    updated_at=datetime.utcnow().isoformat() + "Z",

tests/unit/test_sdk_client.py::TestCaracalClient::test_get_remaining_budget_no_policy
  /home/raw/Documents/workspace/caracalEcosystem/Caracal/caracal/core/policy.py:396: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    current_time = datetime.utcnow()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.14.2-final-0 ________________

Name                         Stmts   Miss  Cover   Missing
----------------------------------------------------------
caracal/__init__.py              1      0   100%
caracal/cli/__init__.py          0      0   100%
caracal/cli/agent.py           113     91    19%   31-33, 69-117, 141-196, 226-264
caracal/cli/ledger.py          177    151    15%   30-31, 53-64, 138-241, 298-480
caracal/cli/main.py            180    113    37%   68-73, 89-94, 101, 127, 139, 153, 164-251, 270-280, 298-308, 326-334, 352-360, 378-387, 405-411, 426-439
caracal/cli/policy.py          136     70    49%   93-103, 107-111, 115-119, 142-153, 194, 199-203, 212-258, 299-300, 309-331
caracal/cli/pricebook.py       163    136    17%   32-34, 58-125, 155-196, 233-307, 344-404
caracal/config/__init__.py       2      0   100%
caracal/config/settings.py     119     35    71%   137, 144-145, 152-159, 165-166, 174-176, 201-202, 281-282, 284-285, 287-288, 290-291, 293-294, 298, 304, 309, 316, 323, 330, 335, 340, 345
caracal/core/__init__.py         0      0   100%
caracal/core/identity.py       100     27    73%   110-111, 135-136, 158, 168, 205, 223-246, 270-277
caracal/core/ledger.py         200    137    32%   60-64, 69, 73, 111-112, 148-149, 151-152, 154-155, 157-158, 162-163, 184-188, 225-240, 265-308, 322-348, 372-374, 401-475, 500-522, 543-568
caracal/core/metering.py        54     32    41%   47-48, 92-124, 147-185, 206-219
caracal/core/policy.py         157     53    66%   65, 131-132, 140-141, 147, 176-178, 255, 273-296, 324-331, 408-474
caracal/core/pricebook.py      142     68    52%   49, 59, 97, 112-119, 140-141, 147-150, 167, 179, 195-257, 281, 287, 298-301, 309, 323-324, 332-343, 373-401, 419, 425, 433, 439-442
caracal/core/retry.py           38     15    61%   66-72, 111-138
caracal/exceptions.py           64      0   100%
caracal/logging_config.py       25      1    96%   27
caracal/sdk/__init__.py          3      0   100%
caracal/sdk/client.py           76     31    59%   76-79, 141-142, 180-203, 230-258, 283-286, 293-299, 333-335
caracal/sdk/context.py          28     20    29%   45-46, 55-98, 116-119
----------------------------------------------------------
TOTAL                         1778    980    45%
Coverage HTML written to dir htmlcov
=========================== short test summary info ============================
FAILED tests/unit/test_persistence_retry.py::TestAgentRegistryRetry::test_agent_registry_persist_permanent_failure - AttributeError: 'PosixPath' object has no attribute 'endswith'
FAILED tests/unit/test_persistence_retry.py::TestLedgerWriterRetry::test_ledger_writer_append_with_transient_failure - caracal.exceptions.LedgerWriteError: Failed to append event to ledger /tmp/tmpq0ylfg_v/ledger.jsonl: Failed to perform atomic append to /tmp/tmpq0ylfg_v/ledger.jsonl: Simulated transient failure
FAILED tests/unit/test_persistence_retry.py::TestPricebookRetry::test_pricebook_persist_with_transient_failure - caracal.exceptions.FileWriteError: Failed to persist pricebook to /tmp/tmp6xrykoad/pricebook.csv: Simulated transient failure
FAILED tests/unit/test_sdk_client.py::TestCaracalClient::test_get_remaining_budget_no_policy - AssertionError: assert Decimal('0') is None
=================== 4 failed, 4 passed, 12 warnings in 0.90s ===================
