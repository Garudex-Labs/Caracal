"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[3194],{1663(e,n,s){s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>o,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"caracalCore/cliReference/database","title":"Database Commands","description":"The db command group manages database schema and migrations.","source":"@site/docs/caracalCore/cliReference/database.md","sourceDirName":"caracalCore/cliReference","slug":"/caracalCore/cliReference/database","permalink":"/caracalCore/cliReference/database","draft":false,"unlisted":false,"editUrl":"https://github.com/Garudex-Labs/Caracal/tree/main/docs/docs/caracalCore/cliReference/database.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"title":"Database Commands"},"sidebar":"caracalSidebar","previous":{"title":"Ledger Commands","permalink":"/caracalCore/cliReference/ledger"},"next":{"title":"Merkle Commands","permalink":"/caracalCore/cliReference/merkle"}}');var r=s(4848),d=s(8453);const a={sidebar_position:5,title:"Database Commands"},l="Database Commands",t={},c=[{value:"Commands Overview",id:"Commands-Overview",level:2},{value:"init-db",id:"init-db",level:2},{value:"Options",id:"Options",level:3},{value:"Examples",id:"Examples",level:3},{value:"Warning",id:"Warning",level:3},{value:"migrate",id:"migrate",level:2},{value:"Arguments",id:"Arguments",level:3},{value:"Options",id:"Options-1",level:3},{value:"Examples",id:"Examples-1",level:3},{value:"status",id:"status",level:2},{value:"Options",id:"Options-2",level:3},{value:"Examples",id:"Examples-2",level:3},{value:"Configuration",id:"Configuration",level:2},{value:"Configuration File",id:"Configuration-File",level:3},{value:"Environment Variables",id:"Environment-Variables",level:3},{value:"Troubleshooting",id:"Troubleshooting",level:2},{value:"See Also",id:"See-Also",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components},{Details:s}=n;return s||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"Database-Commands",children:"Database Commands"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"db"})," command group manages database schema and migrations."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"caracal db COMMAND [OPTIONS]\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"Commands-Overview",children:"Commands Overview"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Command"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"#init-db",children:(0,r.jsx)(n.code,{children:"init-db"})})}),(0,r.jsx)(n.td,{children:"Initialize database schema"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"#migrate",children:(0,r.jsx)(n.code,{children:"migrate"})})}),(0,r.jsx)(n.td,{children:"Run database migrations"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"#status",children:(0,r.jsx)(n.code,{children:"status"})})}),(0,r.jsx)(n.td,{children:"Check database connection and status"})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"init-db",children:"init-db"}),"\n",(0,r.jsx)(n.p,{children:"Initialize the database schema."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"caracal db init-db [OPTIONS]\n"})}),"\n",(0,r.jsx)(n.h3,{id:"Options",children:"Options"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"--drop-existing"})}),(0,r.jsx)(n.td,{children:"false"}),(0,r.jsx)(n.td,{children:"Drop existing tables before creating (DESTRUCTIVE)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"--dry-run"})}),(0,r.jsx)(n.td,{children:"false"}),(0,r.jsx)(n.td,{children:"Show SQL without executing"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"Examples",children:"Examples"}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Initialize Database"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"caracal db init-db\n"})}),(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Output:"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Initializing Caracal database schema...\n\nCreating tables:\n  [OK] agents\n  [OK] policies\n  [OK] policy_versions\n  [OK] ledger_events\n  [OK] delegation_tokens\n  [OK] pending_mandates\n  [OK] merkle_nodes\n  [OK] snapshots\n  [OK] dead_letter_queue\n\nCreating indexes:\n  [OK] idx_ledger_events_principal_id\n  [OK] idx_ledger_events_timestamp\n  [OK] idx_policies_principal_id\n  ...\n\nCreating materialized views:\n  [OK] principal_daily_activity_mv\n  [OK] principal_hourly_activity_mv\n\nDatabase initialized successfully!\n"})})]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Dry Run (Preview SQL)"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"caracal db init-db --dry-run\n"})}),(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Output:"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- DRY RUN: The following SQL would be executed\n\nCREATE TABLE IF NOT EXISTS agents (\n    principal_id UUID PRIMARY KEY,\n    name VARCHAR(255) UNIQUE NOT NULL,\n    owner VARCHAR(255) NOT NULL,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    ...\n);\n\nCREATE TABLE IF NOT EXISTS policies (\n    policy_id UUID PRIMARY KEY,\n    principal_id UUID REFERENCES agents(principal_id),\n    ...\n);\n\n-- ... more SQL statements\n"})})]}),"\n",(0,r.jsx)(n.h3,{id:"Warning",children:"Warning"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Flag"}),(0,r.jsx)(n.th,{children:"Risk Level"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsx)(n.tbody,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"--drop-existing"})}),(0,r.jsx)(n.td,{children:"HIGH"}),(0,r.jsx)(n.td,{children:"Deletes ALL data - never use in production"})]})})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"migrate",children:"migrate"}),"\n",(0,r.jsx)(n.p,{children:"Run database migrations."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"caracal db migrate DIRECTION [OPTIONS]\n"})}),"\n",(0,r.jsx)(n.h3,{id:"Arguments",children:"Arguments"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Argument"}),(0,r.jsx)(n.th,{children:"Values"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsx)(n.tbody,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"DIRECTION"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"up"}),", ",(0,r.jsx)(n.code,{children:"down"})]}),(0,r.jsx)(n.td,{children:"Migration direction"})]})})]}),"\n",(0,r.jsx)(n.h3,{id:"Options-1",children:"Options"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Short"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"--revision"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"-r"})}),(0,r.jsx)(n.td,{children:"head/-1"}),(0,r.jsx)(n.td,{children:"Target revision"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"--sql"})}),(0,r.jsx)(n.td,{}),(0,r.jsx)(n.td,{children:"false"}),(0,r.jsx)(n.td,{children:"Generate SQL instead of executing"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"Examples-1",children:"Examples"}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Apply All Migrations"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"caracal db migrate up\n"})}),(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Output:"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Running migrations...\n\nApplying: 001_initial_schema\n  [OK] Created base tables\n\nApplying: 002_add_policy_versions\n  [OK] Added policy_versions table\n  [OK] Added version triggers\n\nApplying: 003_add_merkle_nodes\n  [OK] Added merkle_nodes table\n  [OK] Added merkle indexes\n\nAll migrations applied successfully!\nCurrent revision: 003_add_merkle_nodes\n"})})]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Migrate to Specific Version"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"caracal db migrate up --revision 002_add_policy_versions\n"})})]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Revert Last Migration"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"caracal db migrate down\n"})}),(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Output:"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Reverting migration: 003_add_merkle_nodes\n  [OK] Dropped merkle_nodes table\n  [OK] Removed merkle indexes\n\nReverted successfully.\nCurrent revision: 002_add_policy_versions\n"})})]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Generate SQL for DBA Review"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"caracal db migrate up --sql > migration.sql\n"})})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"status",children:"status"}),"\n",(0,r.jsx)(n.p,{children:"Check database connection and schema status."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"caracal db status [OPTIONS]\n"})}),"\n",(0,r.jsx)(n.h3,{id:"Options-2",children:"Options"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Short"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsx)(n.tbody,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"--format"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"-f"})}),(0,r.jsx)(n.td,{children:"table"}),(0,r.jsx)(n.td,{children:"Output format: table or json"})]})})]}),"\n",(0,r.jsx)(n.h3,{id:"Examples-2",children:"Examples"}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Check Status"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"caracal db status\n"})}),(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Output:"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Database Status\n===============\n\nConnection\n----------\n  Host:       localhost:5432\n  Database:   caracal\n  User:       caracal\n  Status:     [OK] Connected\n  Latency:    2.3ms\n\nSchema\n------\n  Current Revision:   003_add_merkle_nodes\n  Pending Migrations: 0\n  Last Applied:       2024-01-15T10:30:00Z\n\nTables\n------\n  agents:              125 rows\n  policies:            89 rows\n  policy_versions:     234 rows\n  ledger_events:       1,234,567 rows\n  delegation_tokens:   45 rows\n  pending_mandates:  12 rows\n\nStorage\n-------\n  Total Size:   2.3 GB\n  Index Size:   450 MB\n  Table Size:   1.85 GB\n"})})]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"JSON Output"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"caracal db status --format json\n"})}),(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Output:"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "connection": {\n    "host": "localhost",\n    "port": 5432,\n    "database": "caracal",\n    "user": "caracal",\n    "status": "connected",\n    "latency_ms": 2.3\n  },\n  "schema": {\n    "current_revision": "003_add_merkle_nodes",\n    "pending_migrations": 0,\n    "last_applied": "2024-01-15T10:30:00Z"\n  },\n  "tables": {\n    "agents": 125,\n    "policies": 89,\n    "ledger_events": 1234567\n  },\n  "storage": {\n    "total_bytes": 2469606195,\n    "index_bytes": 471859200,\n    "table_bytes": 1986490163\n  }\n}\n'})})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"Configuration",children:"Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"Configuration-File",children:"Configuration File"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'database:\n  type: postgres\n  host: localhost\n  port: 5432\n  database: caracal\n  user: caracal\n  password: "${DB_PASSWORD}"\n  \n  # Connection pool settings\n  pool_size: 10\n  max_overflow: 20\n  pool_timeout: 30\n  pool_recycle: 1800\n  \n  # SSL settings (production)\n  ssl_mode: require\n  ssl_ca: /path/to/ca.crt\n'})}),"\n",(0,r.jsx)(n.h3,{id:"Environment-Variables",children:"Environment Variables"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Variable"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"DB_HOST"})}),(0,r.jsx)(n.td,{children:"Database hostname"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"DB_PORT"})}),(0,r.jsx)(n.td,{children:"Database port"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"DB_NAME"})}),(0,r.jsx)(n.td,{children:"Database name"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"DB_USER"})}),(0,r.jsx)(n.td,{children:"Database username"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"DB_PASSWORD"})}),(0,r.jsx)(n.td,{children:"Database password"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"DB_SSL_MODE"})}),(0,r.jsx)(n.td,{children:"SSL mode"})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"Troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Error"}),(0,r.jsx)(n.th,{children:"Cause"}),(0,r.jsx)(n.th,{children:"Solution"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Connection refused"}),(0,r.jsx)(n.td,{children:"PostgreSQL not running"}),(0,r.jsxs)(n.td,{children:["Start PostgreSQL: ",(0,r.jsx)(n.code,{children:"docker-compose up -d postgres"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Authentication failed"}),(0,r.jsx)(n.td,{children:"Wrong credentials"}),(0,r.jsx)(n.td,{children:"Check DB_PASSWORD environment variable"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Target not up to date"}),(0,r.jsx)(n.td,{children:"Pending migrations"}),(0,r.jsxs)(n.td,{children:["Run ",(0,r.jsx)(n.code,{children:"caracal db migrate up"})]})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"See-Also",children:"See Also"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./ledger",children:"Ledger Commands"})," - Query data in the database"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./backup",children:"Backup Commands"})," - Backup database state"]}),"\n"]})]})}function o(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},8453(e,n,s){s.d(n,{R:()=>a,x:()=>l});var i=s(6540);const r={},d=i.createContext(r);function a(e){const n=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);