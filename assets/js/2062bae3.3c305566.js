"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[2770],{2011(e,a,n){n.r(a),n.d(a,{assets:()=>s,contentTitle:()=>t,default:()=>h,frontMatter:()=>c,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"caracalCore/deployment/operationalRunbook","title":"Operational Runbook","description":"This runbook covers day-to-day operations for Caracal Core.","source":"@site/docs/caracalCore/deployment/operationalRunbook.md","sourceDirName":"caracalCore/deployment","slug":"/caracalCore/deployment/operationalRunbook","permalink":"/caracalCore/deployment/operationalRunbook","draft":false,"unlisted":false,"editUrl":"https://github.com/Garudex-Labs/Caracal/tree/main/docs/docs/caracalCore/deployment/operationalRunbook.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"title":"Operational Runbook"},"sidebar":"caracalSidebar","previous":{"title":"Production Guide","permalink":"/caracalCore/deployment/production"},"next":{"title":"Caracal Flow","permalink":"/caracalFlow/"}}');var l=n(4848),i=n(8453);const c={sidebar_position:5,title:"Operational Runbook"},t="Operational Runbook",s={},o=[{value:"Common Operations",id:"Common-Operations",level:2},{value:"Register Principal",id:"Register-Principal",level:3},{value:"Create Authority Policy",id:"Create-Authority-Policy",level:3},{value:"Query Principal Activity",id:"Query-Principal-Activity",level:3},{value:"Create Resource Allowlist",id:"Create-Resource-Allowlist",level:3},{value:"Verify Ledger Integrity",id:"Verify-Ledger-Integrity",level:3},{value:"Create Ledger Snapshot",id:"Create-Ledger-Snapshot",level:3},{value:"Monitor Dead Letter Queue",id:"Monitor-Dead-Letter-Queue",level:3},{value:"Troubleshooting",id:"Troubleshooting",level:2},{value:"Gateway Returns 503",id:"Gateway-Returns-503",level:3},{value:"Merkle Verification Failures",id:"Merkle-Verification-Failures",level:3},{value:"High Memory Usage",id:"High-Memory-Usage",level:3},{value:"Backup and Recovery",id:"Backup-and-Recovery",level:2},{value:"PostgreSQL Backup",id:"PostgreSQL-Backup",level:3},{value:"PostgreSQL Restore",id:"PostgreSQL-Restore",level:3},{value:"Event Replay Recovery",id:"Event-Replay-Recovery",level:3},{value:"Scaling",id:"Scaling",level:2},{value:"Horizontal Scaling",id:"Horizontal-Scaling",level:3},{value:"Vertical Scaling",id:"Vertical-Scaling",level:3},{value:"Database Scaling",id:"Database-Scaling",level:3},{value:"Monitoring",id:"Monitoring",level:2},{value:"Key Metrics",id:"Key-Metrics",level:3},{value:"Grafana Dashboards",id:"Grafana-Dashboards",level:3},{value:"Emergency Procedures",id:"Emergency-Procedures",level:2},{value:"Complete System Outage",id:"Complete-System-Outage",level:3},{value:"Data Corruption Detected",id:"Data-Corruption-Detected",level:3}];function d(e){const a={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(a.header,{children:(0,l.jsx)(a.h1,{id:"Operational-Runbook",children:"Operational Runbook"})}),"\n",(0,l.jsx)(a.p,{children:"This runbook covers day-to-day operations for Caracal Core."}),"\n",(0,l.jsx)(a.h2,{id:"Common-Operations",children:"Common Operations"}),"\n",(0,l.jsx)(a.h3,{id:"Register-Principal",children:"Register Principal"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:'caracal agent register \\\n  --name "my-agent" \\\n  --description "My AI agent" \\\n  --owner "user@example.com"\n'})}),"\n",(0,l.jsx)(a.h3,{id:"Create-Authority-Policy",children:"Create Authority Policy"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:'caracal policy create \\\n  --agent-id <principal-id> \\\n  --resources "api:external/*" \\\n  --actions "read" "write" "execute" \\\n  --max-validity 86400 \\\n  --delegation-depth 1\n'})}),"\n",(0,l.jsx)(a.h3,{id:"Query-Principal-Activity",children:"Query Principal Activity"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:'caracal ledger query \\\n  --agent-id <principal-id> \\\n  --start-time "2024-01-01T00:00:00Z" \\\n  --end-time "2024-01-31T23:59:59Z"\n\n# Current daily activity\ncaracal ledger query \\\n  --agent-id <principal-id> \\\n  --time-window daily\n'})}),"\n",(0,l.jsx)(a.h3,{id:"Create-Resource-Allowlist",children:"Create Resource Allowlist"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:'# Regex pattern\ncaracal allowlist create \\\n  --agent-id <agent-id> \\\n  --pattern "^https://api\\\\.openai\\\\.com/.*$" \\\n  --pattern-type regex\n\n# Glob pattern\ncaracal allowlist create \\\n  --agent-id <agent-id> \\\n  --pattern "https://api.anthropic.com/*" \\\n  --pattern-type glob\n'})}),"\n",(0,l.jsx)(a.h3,{id:"Verify-Ledger-Integrity",children:"Verify Ledger Integrity"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:'# Verify specific batch\ncaracal merkle verify-batch --batch-id <batch-id>\n\n# Verify time range\ncaracal merkle verify-range \\\n  --start-time "2024-01-01T00:00:00Z" \\\n  --end-time "2024-01-31T23:59:59Z"\n'})}),"\n",(0,l.jsx)(a.h3,{id:"Create-Ledger-Snapshot",children:"Create Ledger Snapshot"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"caracal snapshot create\ncaracal snapshot list\ncaracal snapshot restore --snapshot-id <snapshot-id>\n"})}),"\n",(0,l.jsx)(a.h3,{id:"Monitor-Dead-Letter-Queue",children:"Monitor Dead Letter Queue"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"caracal dlq list\ncaracal dlq get --event-id <event-id>\n"})}),"\n",(0,l.jsx)(a.h2,{id:"Troubleshooting",children:"Troubleshooting"}),"\n",(0,l.jsx)(a.h3,{id:"Gateway-Returns-503",children:"Gateway Returns 503"}),"\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"Diagnosis:"})}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"curl http://gateway:8443/health\nkubectl logs -f deployment/caracal-gateway --tail=100\ncaracal db health-check\n"})}),"\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"Common Causes:"})}),"\n",(0,l.jsxs)(a.ul,{children:["\n",(0,l.jsx)(a.li,{children:"Database unavailable"}),"\n",(0,l.jsx)(a.li,{children:"Redis unavailable"}),"\n"]}),"\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"Resolution:"})}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"kubectl rollout restart deployment/<component>\n"})}),"\n",(0,l.jsx)(a.h3,{id:"Merkle-Verification-Failures",children:"Merkle Verification Failures"}),"\n",(0,l.jsxs)(a.p,{children:[(0,l.jsx)(a.strong,{children:"CRITICAL"}),": This indicates potential data tampering."]}),"\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"Immediate Actions:"})}),"\n",(0,l.jsxs)(a.ol,{children:["\n",(0,l.jsx)(a.li,{children:"Stop all writes to affected batches"}),"\n",(0,l.jsx)(a.li,{children:"Preserve evidence (database dumps, logs)"}),"\n",(0,l.jsx)(a.li,{children:"Notify security team"}),"\n",(0,l.jsx)(a.li,{children:"Investigate root cause"}),"\n"]}),"\n",(0,l.jsx)(a.h3,{id:"High-Memory-Usage",children:"High Memory Usage"}),"\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"Diagnosis:"})}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"kubectl top pods\ncurl http://gateway:9090/metrics | grep memory\n"})}),"\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"Resolution:"})}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"kubectl set resources deployment/<component> \\\n  --limits=memory=8Gi \\\n  --requests=memory=4Gi\n"})}),"\n",(0,l.jsx)(a.h2,{id:"Backup-and-Recovery",children:"Backup and Recovery"}),"\n",(0,l.jsx)(a.h3,{id:"PostgreSQL-Backup",children:"PostgreSQL Backup"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"# Manual backup\nkubectl exec -it postgresql-0 -- \\\n  pg_dump -U caracal caracal | gzip > backup.sql.gz\n\n# Using CLI\ncaracal backup create --type postgresql\n"})}),"\n",(0,l.jsx)(a.h3,{id:"PostgreSQL-Restore",children:"PostgreSQL Restore"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"# Stop consumers\nkubectl scale deployment/caracal-ledger-writer --replicas=0\nkubectl scale deployment/caracal-metrics-aggregator --replicas=0\n\n# Restore\ngunzip -c backup.sql.gz | \\\n  kubectl exec -i postgresql-0 -- psql -U caracal caracal\n\n# Verify and restart\ncaracal db health-check\nkubectl scale deployment/caracal-ledger-writer --replicas=3\n"})}),"\n",(0,l.jsx)(a.h3,{id:"Event-Replay-Recovery",children:"Event Replay Recovery"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"# Stop consumers\nkubectl scale deployment/caracal-ledger-writer --replicas=0\n\n# Reset database\ncaracal db reset --confirm\n\n# Restore from snapshot\ncaracal snapshot restore --snapshot-id <snapshot-id>\n\n# Replay events\ncaracal replay start --from-snapshot <snapshot-id>\n\n# Monitor and verify\ncaracal replay status\ncaracal merkle verify-range --start-time <timestamp> --end-time now\n"})}),"\n",(0,l.jsx)(a.h2,{id:"Scaling",children:"Scaling"}),"\n",(0,l.jsx)(a.h3,{id:"Horizontal-Scaling",children:"Horizontal Scaling"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"# Gateway\nkubectl scale deployment/caracal-gateway --replicas=5\n\n# Consumers\nkubectl scale deployment/caracal-ledger-writer --replicas=10\n\n# Auto-scaling\nkubectl autoscale deployment/caracal-gateway \\\n  --min=3 --max=10 --cpu-percent=70\n"})}),"\n",(0,l.jsx)(a.h3,{id:"Vertical-Scaling",children:"Vertical Scaling"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"kubectl set resources deployment/caracal-gateway \\\n  --limits=cpu=4,memory=8Gi \\\n  --requests=cpu=2,memory=4Gi\n"})}),"\n",(0,l.jsx)(a.h3,{id:"Database-Scaling",children:"Database Scaling"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-yaml",children:'database:\n  pool_size: 50\n  max_overflow: 100\n  read_replica_url: "postgresql://replica:5432/caracal"\n'})}),"\n",(0,l.jsx)(a.h2,{id:"Monitoring",children:"Monitoring"}),"\n",(0,l.jsx)(a.h3,{id:"Key-Metrics",children:"Key Metrics"}),"\n",(0,l.jsxs)(a.ul,{children:["\n",(0,l.jsxs)(a.li,{children:[(0,l.jsx)(a.code,{children:"caracal_gateway_requests_total"})," - Total requests"]}),"\n",(0,l.jsxs)(a.li,{children:[(0,l.jsx)(a.code,{children:"caracal_gateway_request_duration_seconds"})," - Request latency"]}),"\n",(0,l.jsxs)(a.li,{children:[(0,l.jsx)(a.code,{children:"caracal_merkle_verification_failures_total"})," - Verification failures"]}),"\n",(0,l.jsxs)(a.li,{children:[(0,l.jsx)(a.code,{children:"caracal_dlq_size"})," - Dead letter queue size"]}),"\n"]}),"\n",(0,l.jsx)(a.h3,{id:"Grafana-Dashboards",children:"Grafana Dashboards"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"kubectl apply -f monitoring/grafana/dashboards/\n"})}),"\n",(0,l.jsx)(a.h2,{id:"Emergency-Procedures",children:"Emergency Procedures"}),"\n",(0,l.jsx)(a.h3,{id:"Complete-System-Outage",children:"Complete System Outage"}),"\n",(0,l.jsxs)(a.ol,{children:["\n",(0,l.jsxs)(a.li,{children:["Check infrastructure: ",(0,l.jsx)(a.code,{children:"kubectl get pods --all-namespaces"})]}),"\n",(0,l.jsxs)(a.li,{children:["Check recent changes: ",(0,l.jsx)(a.code,{children:"kubectl rollout history deployment/<component>"})]}),"\n",(0,l.jsx)(a.li,{children:"Restart in order: Database > Redis > Gateway > Consumers"}),"\n",(0,l.jsxs)(a.li,{children:["Verify health: ",(0,l.jsx)(a.code,{children:"curl http://gateway:8443/health"})]}),"\n"]}),"\n",(0,l.jsx)(a.h3,{id:"Data-Corruption-Detected",children:"Data Corruption Detected"}),"\n",(0,l.jsxs)(a.ol,{children:["\n",(0,l.jsxs)(a.li,{children:["\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"STOP ALL WRITES:"})}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"kubectl scale deployment/caracal-gateway --replicas=0\nkubectl scale deployment/caracal-ledger-writer --replicas=0\n"})}),"\n"]}),"\n",(0,l.jsxs)(a.li,{children:["\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"Preserve Evidence:"})}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:'caracal backup create --type postgresql --tag "corruption-evidence"\n'})}),"\n"]}),"\n",(0,l.jsxs)(a.li,{children:["\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"Notify Security Team"})}),"\n"]}),"\n",(0,l.jsxs)(a.li,{children:["\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"Investigate and Recover"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:a}={...(0,i.R)(),...e.components};return a?(0,l.jsx)(a,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},8453(e,a,n){n.d(a,{R:()=>c,x:()=>t});var r=n(6540);const l={},i=r.createContext(l);function c(e){const a=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function t(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:c(e.components),r.createElement(i.Provider,{value:a},e.children)}}}]);