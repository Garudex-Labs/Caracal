# Docker Compose configuration for Caracal Gateway Proxy
# Requirements: 17.1, 17.3
#
# This compose file sets up:
# - PostgreSQL database
# - Caracal Gateway Proxy
#
# Usage:
#   docker-compose -f docker-compose.gateway.yml up -d
#   docker-compose -f docker-compose.gateway.yml logs -f gateway
#   docker-compose -f docker-compose.gateway.yml down

version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:14-alpine
    container_name: caracal-postgres
    environment:
      POSTGRES_DB: caracal
      POSTGRES_USER: caracal
      POSTGRES_PASSWORD: ${DB_PASSWORD:-caracal_dev_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U caracal"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - caracal-network
    restart: unless-stopped

  # Caracal Gateway Proxy
  gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    image: caracal-gateway:latest
    container_name: caracal-gateway
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${GATEWAY_PORT:-8443}:8443"
      - "${METRICS_PORT:-9090}:9090"
    volumes:
      # Mount TLS certificates (create ./certs directory with your certificates)
      - ./certs:/etc/caracal/tls:ro
      # Optional: Mount custom configuration
      # - ./config:/etc/caracal/config:ro
    environment:
      # Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: caracal
      DB_USER: caracal
      DB_PASSWORD: ${DB_PASSWORD:-caracal_dev_password}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-10}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-5}
      DB_POOL_TIMEOUT: ${DB_POOL_TIMEOUT:-30}
      
      # Gateway Configuration
      LISTEN_ADDRESS: "0.0.0.0:8443"
      AUTH_MODE: ${AUTH_MODE:-jwt}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-30}
      MAX_REQUEST_SIZE_MB: ${MAX_REQUEST_SIZE_MB:-10}
      
      # TLS Configuration
      TLS_CERT_FILE: /etc/caracal/tls/server.crt
      TLS_KEY_FILE: /etc/caracal/tls/server.key
      TLS_CA_FILE: /etc/caracal/tls/ca.crt
      
      # JWT Configuration (when AUTH_MODE=jwt)
      JWT_PUBLIC_KEY_PATH: /etc/caracal/tls/jwt_public.pem
      JWT_ALGORITHM: ${JWT_ALGORITHM:-RS256}
      
      # Replay Protection
      ENABLE_REPLAY_PROTECTION: ${ENABLE_REPLAY_PROTECTION:-true}
      NONCE_CACHE_TTL: ${NONCE_CACHE_TTL:-300}
      NONCE_CACHE_SIZE: ${NONCE_CACHE_SIZE:-100000}
      TIMESTAMP_WINDOW: ${TIMESTAMP_WINDOW:-300}
      
      # Policy Cache (Degraded Mode)
      ENABLE_POLICY_CACHE: ${ENABLE_POLICY_CACHE:-true}
      POLICY_CACHE_TTL: ${POLICY_CACHE_TTL:-60}
      POLICY_CACHE_MAX_SIZE: ${POLICY_CACHE_MAX_SIZE:-10000}
      
      # Provisional Charges
      PROVISIONAL_CHARGE_EXPIRATION: ${PROVISIONAL_CHARGE_EXPIRATION:-300}
      PROVISIONAL_CHARGE_MAX_TIMEOUT: ${PROVISIONAL_CHARGE_MAX_TIMEOUT:-60}
      PROVISIONAL_CHARGE_CLEANUP_INTERVAL: ${PROVISIONAL_CHARGE_CLEANUP_INTERVAL:-60}
      PROVISIONAL_CHARGE_CLEANUP_BATCH_SIZE: ${PROVISIONAL_CHARGE_CLEANUP_BATCH_SIZE:-1000}
    networks:
      - caracal-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8443/health').read()"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    restart: unless-stopped

networks:
  caracal-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
